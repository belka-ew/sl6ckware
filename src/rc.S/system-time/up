########################################################
# This service configures the system time at boot time #
########################################################

foreground { echo "Starting oneshot service:  system-time" }
# Set the system time from the hardware clock using hwclock --hctosys.
# But first, check if hwclock exists.
backtick -n -D "" HWCLOCK { redirfd -w 2 /dev/null which hwclock }
importas -u hwclock HWCLOCK
ifelse -n { [ -x $hwclock ] }
{
  foreground {
  echo "hwclock not found! Aborting...
(ERROR) Failed to start oneshot service:  system-time"
  }
  exit 1
}
# Check for a broken motherboard RTC clock (where ioports for rtc are
# unknown) to prevent hwclock causing a hang:
backtick CLOCK_OPT {
  if -n { grep -q " : rtc" /proc/ioports }
  printf --directisa
}
importas -u clock_opt CLOCK_OPT
ifthenelse { [ /etc/adjtime -nt /etc/hardwareclock ] }
{
  backtick -n TIME_MODE { sed "$!d; s/LOCAL/localtime/" /etc/adjtime }
  importas -u time_mode TIME_MODE
  foreground { echo -n "Setting system time from the hardware clock (${time_mode}):  " }
  hwclock $clock_opt --hctosys
}
{
  backtick -n TIME_MODE { sed "$!d; s/UTC/utc/" /etc/hardwareclock }
  importas -u time_mode TIME_MODE
  foreground {
    pipeline { echo -n "Setting system time from the hardware clock (${time_mode}):  " }
    sed "s/utc/UTC/"
  }
  hwclock $clock_opt --${time_mode} --hctosys
}
# Display current time after initializing system time
date
