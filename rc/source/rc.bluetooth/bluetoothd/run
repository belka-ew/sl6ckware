#!/bin/execlineb -P

##############################
# Start the bluetooth daemon #
##############################

fdmove -c 2 1
ifelse { [ ! -d /sys/class/bluetooth ] }
{
  foreground { echo "bluetoothd: This system doesn't support bluetooth! Aborting..." }
  exit 125
}
backtick -ni BLUETOOTHD { which bluetoothd }
importas -u bluetoothd BLUETOOTHD
foreground { echo "bluetoothd: Starting bluetoothd: ${bluetoothd} -n" }
# Use org.bluez dbus address availability as readiness indicator
s6-notifyoncheck -dc "pipeline { dbus-send --system --dest=org.freedesktop.DBus \
--type=method_call --print-reply=literal /org/freedesktop/DBus \
org.freedesktop.DBus.NameHasOwner string:org.bluez } grep -wq true"
emptyenv $bluetoothd -n
